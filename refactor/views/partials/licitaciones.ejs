<section class="planilla-section">
  <div class="erp-main-card">
    <div class="erp-header-row">
      <div class="titulo-dota">
        <i class="fas fa-file-signature"></i> Licitaciones
      </div>
    </div>

    <!-- Tabs: Licitaciones / R.Vigentes / Garantias -->
    <div id="lic-tabs" class="tabs-simple" style="display:flex; gap:8px; margin:6px 0 12px; align-items:center">
      <button class="btn-secundario" data-tab="lic">Licitaciones</button>
      <button class="btn-secundario" data-tab="vig">R.Vigentes</button>
      <button class="btn-secundario" data-tab="gar">Garantias</button>
      <button id="btn-vig-clear" class="btn-secundario" style="margin-left:auto; display:none;">Limpiar seleccion</button>
    </div>

    <div id="lic-tab" class="lic-tab-pane" style="display:block;">
    <div class="erp-table-card">
      <table class="tabla-erp tabla-erp-inputs">
        <thead>
          <tr>
            <th>Nº Licitación</th>
            <th>Fecha</th>
            <th>Fecha de Cierre</th>
            <th>Observación</th>
            <th>Acción</th>
          </tr>
        </thead>
        <tbody id="tbody-licitaciones"></tbody>
      </table>
    </div>

    </div> <!-- /lic-tab -->

    <div id="vig-tab" class="lic-tab-pane" style="display:none;">
      <div class="erp-table-card">
        <table class="tabla-erp">
          <thead>
            <tr>
              <th>Nro Pedido</th>
              <th>Código</th>
              <th>Descripción</th>
              <th>Cantidad</th>
              <th>Destino</th>
              <th>Razón Social</th>
              <th>Pendientes</th>
            </tr>
          </thead>
          <tbody id="tbody-vigentes"></tbody>
        </table>
      </div>
    </div>



    <div id="gar-tab" class="lic-tab-pane" style="display:none;">
      <div class="erp-table-card">
        <table class="tabla-erp tabla-erp-inputs tabla-garantias">
          <thead>
            <tr>
              <th>#</th>
              <th>ID Cliente</th>
              <th>Ingreso</th>
              <th>Cabecera</th>
              <th>Interno</th>
              <th>Código</th>
              <th>Equipo</th>
              <th>Cantidad</th>
              <th>Colocado</th>
              <th>Detalle</th>
              <th>Fecha proveedor</th>
            </tr>
          </thead>
          <tbody id="tbody-garantias"></tbody>
        </table>
      </div>
    </div>    <div id="lic-panel" class="erp-panel-flotante">
      <button id="btn-lic-agregar" class="icon-button-erp agregar" title="Agregar">
        <i class="fas fa-plus"></i>
      </button>
      <button id="btn-lic-modificar" class="icon-button-erp modificar" title="Modificar">
        <i class="fas fa-edit"></i>
      </button>
      <button id="btn-lic-eliminar" class="icon-button-erp eliminar" title="Eliminar">
        <i class="fas fa-trash"></i>
      </button>
    </div>

    <div id="gar-panel" class="erp-panel-flotante" style="display:none;">
      <button id="btn-gar-agregar" class="icon-button-erp agregar" title="Agregar garantia">
        <i class="fas fa-plus"></i>
      </button>
      <button id="btn-gar-modificar" class="icon-button-erp modificar" title="Editar garantia">
        <i class="fas fa-edit"></i>
      </button>
      <button id="btn-gar-eliminar" class="icon-button-erp eliminar" title="Eliminar garantia">
        <i class="fas fa-trash"></i>
      </button>
      <button id="btn-gar-importar" class="icon-button-erp importar" title="Importar desde Excel/CSV">
        <i class="fas fa-file-import"></i>
      </button>
      <input type="file" id="gar-import-file" accept=".xlsx,.xls,.csv,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,application/vnd.ms-excel,text/csv" style="display:none;" />
    </div>
  </div>

  <!-- Modal Garantia -->
  <div id="modal-garantia" class="modal-refactor" style="display:none;">
    <div class="modal-contenido-refactor modal-erp-producto" style="max-width:960px;">
      <span class="cerrar" onclick="(function(){const m=document.getElementById('modal-garantia'); if(m) m.style.display='none';})()">&times;</span>
      <h2 class="modal-titulo-principal" id="gar-modal-title">
        <i class="fas fa-shield-alt"></i> Garantia
      </h2>

      <form id="form-garantia" autocomplete="off">
        <div class="form-grid doble">
          <div>
            <label>ID Cliente</label>
            <input type="text" name="id_cliente" />
          </div>
          <div>
            <label>Ingreso</label>
            <input type="datetime-local" name="ingreso" />
          </div>
        </div>
        <div class="form-grid doble">
          <div>
            <label>Cabecera</label>
            <input type="text" name="cabecera" />
          </div>
          <div>
            <label>Interno</label>
            <input type="text" name="interno" />
          </div>
        </div>
        <div class="form-grid doble">
          <div>
            <label>Codigo</label>
            <input type="text" name="codigo" />
          </div>
          <div>
            <label>Alternativo</label>
            <input type="text" name="alt" />
          </div>
        </div>
        <div class="form-grid doble">
          <div>
            <label>Cantidad</label>
            <input type="number" name="cantidad" min="1" step="1" value="1" />
          </div>
          <div>
            <label>Notificacion</label>
            <input type="text" name="notificacion" />
          </div>
        </div>
        <div class="form-grid doble">
          <div>
            <label>Fecha notificacion</label>
            <input type="date" name="notificado_en" />
          </div>
        </div>
        <div class="form-grid">
          <div>
            <label>Detalle</label>
            <textarea name="detalle" rows="2"></textarea>
          </div>
        </div>
        <div class="form-grid doble">
          <div>
            <label>Recepcion</label>
            <input type="text" name="recepcion" />
          </div>
          <div>
            <label>Codigo Proveedor</label>
            <input type="text" name="cod_proveedor" />
          </div>
        </div>
        <div class="form-grid doble">
          <div>
            <label>Proveedor</label>
            <input type="text" name="proveedor" />
          </div>
          <div>
            <label>Ref Proveedor</label>
            <input type="text" name="ref_proveedor" />
          </div>
        </div>
        <div class="form-grid doble">
          <div>
            <label>Ref Proveedor 2</label>
            <input type="text" name="ref_proveedor_alt" />
          </div>
          <div>
            <label>Resolucion</label>
            <input type="text" name="resolucion" />
          </div>
        </div>
        <div style="text-align:right; margin-top:16px;">
          <button type="submit" class="btn-guardar">Guardar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Detalle Licitación -->
  <div id="modal-licitacion-detalle" class="modal-refactor" style="display:none;">
    <div class="modal-contenido-refactor modal-erp-producto" style="max-width:900px;">
      <span class="cerrar" onclick="(function(){const m=document.getElementById('modal-licitacion-detalle'); if(m) m.style.display='none';})()">&times;</span>
      <h2 class="modal-titulo-principal">
        <i class="fas fa-folder-open"></i> Detalle Licitación <span id="lic-det-nro"></span>
      </h2>

      <div class="detalle-grid" style="display:grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-bottom:10px;">
        <p><b>Fecha:</b> <span id="lic-det-fecha">-</span></p>
        <p><b>Cierre:</b> <span id="lic-det-cierre">-</span></p>
        <p style="grid-column:1 / span 2"><b>Observación:</b> <span id="lic-det-observacion">-</span></p>
      </div>

      <div class="erp-table-card">
        <table class="tabla-erp tabla-erp-inputs">
          <thead>
            <tr>
              <th>Código</th>
              <th>Descripción</th>
              <th>Cantidad</th>
              <th>Estado</th>
            </tr>
          </thead>
          <tbody id="tbody-licitacion-items"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Modal ABM Licitación -->
  <div id="modal-licitacion-abm" class="modal-refactor" style="display:none;">
    <div class="modal-contenido-refactor modal-erp-producto" style="max-width:960px;">
      <span class="cerrar" onclick="(function(){const m=document.getElementById('modal-licitacion-abm'); if(m) m.style.display='none';})()">&times;</span>
      <h2 class="modal-titulo-principal" id="lic-abm-title">
        <i class="fas fa-file-signature"></i> Licitación
      </h2>

      <form id="form-licitacion" autocomplete="off">
        <div class="form-grid doble">
          <div>
            <label for="lic-nro">Nº Licitación *</label>
            <input type="text" name="nro_licitacion" id="lic-nro" required />
          </div>
          <div>
            <label for="lic-fecha">Fecha *</label>
            <input type="date" name="fecha" id="lic-fecha" required />
          </div>
        </div>

        <div class="form-grid doble">
          <div>
            <label for="lic-cierre">Fecha de Cierre *</label>
            <input type="date" name="fecha_cierre" id="lic-cierre" required />
          </div>
          <div>
            <label for="lic-obs">Observación</label>
            <input type="text" name="observacion" id="lic-obs" />
          </div>
        </div>

        <div class="erp-table-card" style="margin-top:8px;">
          <table class="tabla-erp tabla-erp-inputs">
            <thead>
              <tr>
                <th>Código</th>
                <th>Descripción</th>
                <th>Cantidad</th>
                <th>Estado</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody id="tbody-lic-items"></tbody>
          </table>
        </div>

        <div class="lic-actions-row">
          <div class="left">
            <button id="btn-lic-add-item" type="button" class="btn-secundario">
              <i class="fas fa-plus"></i> Agregar Item
            </button>
          </div>
          <div class="right">
            <button type="submit" class="btn-guardar">
              <i class="fas fa-save"></i> Guardar
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>
</section>

<!-- Modal Selección de Familia (Equipo) -->
<div id="modal-lic-familias" class="modal-refactor" style="display:none;">
  <div class="modal-contenido-refactor modal-erp-producto" style="max-width:720px;">
    <span class="cerrar" onclick="(function(){const m=document.getElementById('modal-lic-familias'); if(m) m.style.display='none';})()">&times;</span>
    <h2 class="modal-titulo-principal"><i class="fas fa-layer-group"></i> Seleccionar Equipo/Familia</h2>

    <div class="buscador-historial" style="margin-top:0;">
      <input type="text" id="lic-buscar-familia" class="input-buscar" placeholder="Buscar por código o descripción..." />
      <button id="btn-lic-buscar-familia" class="btn-primary"><i class="fas fa-search"></i> Buscar</button>
    </div>

    <div class="erp-table-card" style="margin-top:6px;">
      <table class="tabla-erp">
        <thead>
          <tr>
            <th>Elegir</th>
            <th>Código</th>
            <th>Descripción</th>
            <th>Categoría</th>
          </tr>
        </thead>
        <tbody id="tbody-lic-familias"></tbody>
      </table>
    </div>
  </div>
</div>
<script>
(function(){
  function bindTabs(){
    var bar = document.getElementById('lic-tabs');
    var tabLic = document.getElementById('lic-tab');
    var tabVig = document.getElementById('vig-tab');
    if(!bar || bar._bound) return; bar._bound = true;
    if(!tabLic || !tabVig) return;
    bar.addEventListener('click', function(e){
      var btn = e.target.closest('button[data-tab]'); if(!btn) return;
      var which = btn.getAttribute('data-tab');
      tabLic.style.display = which==='lic' ? 'block' : 'none';
      tabVig.style.display = which==='vig' ? 'block' : 'none';
      if(which==='vig'){
        var tb = document.getElementById('tbody-vigentes');
        if(tb && !tb._loaded){
          tb._loaded = true; tb.innerHTML = "<tr><td colspan='7' style='text-align:center; padding:10px; color:#666'><i class='fas fa-spinner fa-spin'></i> Cargando...</td></tr>";
          fetch('/api/reparaciones_dota', { credentials:'include' })
            .then(function(r){ return r.json(); })
            .then(function(arr){
              var lista = Array.isArray(arr) ? arr : [];
              if(lista.length===0){ tb.innerHTML = "<tr><td colspan='7' style='text-align:center; padding:10px; color:#666'>Sin vigentes.</td></tr>"; return; }
              tb.innerHTML = lista.map(function(r){ return (
                "<tr>"+
                "<td>"+(r.nro_pedido||'-')+"</td>"+
                "<td>"+(r.codigo||'-')+"</td>"+
                "<td>"+(r.descripcion||'-')+"</td>"+
                "<td>"+(r.cantidad||'-')+"</td>"+
                "<td>"+(r.destino||'-')+"</td>"+
                "<td>"+(r.razon_social||'-')+"</td>"+
                "<td>"+((r.pendientes!=null)?r.pendientes:'-')+"</td>"+
                "</tr>"); }).join('');
            })
            .catch(function(){ tb.innerHTML = "<tr><td colspan='7' style='text-align:center; padding:10px; color:red'>Error al cargar.</td></tr>"; });
        }
      }
    });
  }
  if(document.readyState !== 'loading'){ bindTabs(); }
  else { document.addEventListener('DOMContentLoaded', bindTabs); }
  document.addEventListener('view:changed', function(e){ if(e.detail==='licitaciones'){ setTimeout(bindTabs, 30); } });
})();
</script>

<script>
(function(){
  var bar = document.getElementById('lic-tabs');
  var btnClear = document.getElementById('btn-vig-clear');
  function toggleClear(show){ if(btnClear) btnClear.style.display = show? 'inline-flex':'none'; }
  function clearVig(){ try{ var tb=document.getElementById('tbody-vigentes'); if(tb){ tb.querySelectorAll('tr.selected').forEach(function(r){ r.classList.remove('selected'); }); } if(window) window.vigSeleccionada=null; }catch(_){} }
  if(bar && !bar._clearBound){
    bar._clearBound = true;
    bar.addEventListener('click', function(e){ var b=e.target.closest('button[data-tab]'); if(!b) return; var which=b.getAttribute('data-tab'); toggleClear(which==='vig'); });
    if(btnClear){ btnClear.addEventListener('click', function(){ clearVig(); }); }
  }
})();
</script>
