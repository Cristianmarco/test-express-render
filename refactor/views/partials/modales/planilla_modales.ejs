<!-- MODAL PLANILLA DIARIA -->
<div id="modal-planilla" class="modal-refactor">
  <style>
    #modal-planilla .tabla-erp td { vertical-align: middle; }
    #modal-planilla .tabla-erp td.garantia-si { color: #b00020; font-weight: 600; }
    #modal-planilla .tabla-erp td.garantia-no { color: #2e7d32; font-weight: 600; }
    #modal-planilla .modal-planilla-header { display: flex; align-items: center; justify-content: space-between; gap: 12px; flex-wrap: wrap; }
    #modal-planilla .modal-planilla-actions { display: flex; align-items: center; gap: 8px; margin-left: auto; }
    #modal-planilla .modal-planilla-actions label { font-size: 0.85rem; font-weight: 600; color: #1a5a90; }
    #modal-planilla .campo-orden-planilla { padding: 6px 10px; border: 1px solid #c5d8ef; border-radius: 6px; font-size: 13px; }
  </style>
  <div class="modal-contenido-refactor modal-erp-producto modal-agregar-producto-grande">
    <span class="cerrar" onclick="cerrarModalPlanilla()">&times;</span>
    <div class="modal-planilla-header">
      <h2 class="modal-titulo-principal"><i class="fas fa-clipboard-list"></i> Reparaciones del <span id="fecha-planilla"></span></h2>
      <div class="modal-planilla-actions">
        <label for="orden-planilla">Orden</label>
        <select id="orden-planilla" class="campo-orden-planilla">
          <option value="ingreso">Ingreso</option>
          <option value="tecnico">Tecnico (hora inicio)</option>
          <option value="id_reparacion">ID reparacion</option>
          <option value="nro_pedido">Nro pedido</option>
        </select>
      </div>
    </div>

    <div class="erp-table-card">
      <table class="tabla-erp">
        <thead>
          <tr>
            <th>#</th>
            <th>Cliente</th>
            <th>ID Reparacion</th>
            <th>Nro Coche</th>
            <th>Equipo</th>
            <th>Tecnico</th>
            <th>Garantia</th>
            <th>Nro Pedido</th>
            <th>Observaciones</th>
          </tr>
        </thead>
        <tbody id="tbody-reparaciones"></tbody>
      </table>
    </div>

    <div class="erp-panel-flotante">
      <button id="btn-ver-detalle" class="icon-button-erp visualizar" title="Ver Detalle"><i class="fas fa-eye"></i></button>
      <button id="btn-agregar-rep" class="icon-button-erp agregar" title="Agregar"><i class="fas fa-plus"></i></button>
      <button id="btn-modificar-rep" class="icon-button-erp modificar" title="Editar"><i class="fas fa-edit"></i></button>
      <button id="btn-eliminar-rep" class="icon-button-erp eliminar" title="Eliminar"><i class="fas fa-trash"></i></button>
      <button id="btn-reporte-garantia" class="icon-button-erp visualizar" title="Informe de garantía">
        <i class="fas fa-file-alt"></i>
      </button>
      <div class="panel-spacer"></div>
      <button id="btn-exportar-planilla" class="icon-button-erp exportar-min" title="Exportar planilla diaria">
        <i class="fas fa-file-excel"></i>
      </button>
      <div class="export-range-group" style="display:flex; gap:6px; align-items:center; margin-left:8px;">
        <input type="date" id="planilla-rango-desde" title="Desde" style="padding:4px 6px; height:32px; border:1px solid #cdd6e1; border-radius:4px; font-size:12px;">
        <input type="date" id="planilla-rango-hasta" title="Hasta" style="padding:4px 6px; height:32px; border:1px solid #cdd6e1; border-radius:4px; font-size:12px;">
        <button id="btn-exportar-planilla-rango" class="icon-button-erp exportar-min" title="Exportar rango (multi-hoja)">
          <i class="fas fa-clone"></i>
        </button>
      </div>
      <div class="panel-counter" title="Cantidad de equipos del día">
        <i class="fas fa-list-check"></i>
        <span style="opacity:.8">Equipos:</span>
        <span id="planilla-count">0</span>
      </div>
    </div>
  </div>
</div>

<!-- MODAL REPUESTOS POR PEDIDO -->
<div id="modal-repuestos-planilla" class="modal-refactor" style="display:none;">
  <style>
    #modal-repuestos-planilla .form-repuestos-grid { display: grid; grid-template-columns: 1.2fr 1fr 1fr; gap: 10px; }
    #modal-repuestos-planilla .form-repuestos-grid label { font-size: 0.85rem; font-weight: 600; color: #1a5a90; }
    #modal-repuestos-planilla .form-repuestos-grid input { padding: 6px 10px; border: 1px solid #c5d8ef; border-radius: 6px; font-size: 13px; }
    #modal-repuestos-planilla .repuestos-actions { margin-top: 10px; display: flex; gap: 8px; align-items: center; }
    #modal-repuestos-planilla .repuestos-table { margin-top: 12px; }
    #modal-repuestos-planilla .repuestos-table thead th { white-space: nowrap; }
    #modal-repuestos-planilla .modal-contenido-refactor { overflow-y: auto; max-height: 90vh; }
    #modal-repuestos-planilla .erp-table-card { flex: 0 0 auto; min-height: 140px; }
  </style>
  <div class="modal-contenido-refactor modal-erp-producto modal-agregar-producto-grande" style="max-width:860px;">
    <span class="cerrar" onclick="cerrarModalRepuestosPlanilla()">&times;</span>
    <h2 class="modal-titulo-principal"><i class="fas fa-cubes"></i> Repuestos por Pedido</h2>

    <div class="form-repuestos-grid">
      <div>
        <label for="repuestos-nro-pedido">Nro de Pedido</label>
        <input type="text" id="repuestos-nro-pedido" placeholder="Ingrese nro de pedido" />
      </div>
      <div>
        <label for="repuestos-desde">Desde Fecha</label>
        <input type="date" id="repuestos-desde" />
      </div>
      <div>
        <label for="repuestos-hasta">Hasta Fecha</label>
        <input type="date" id="repuestos-hasta" />
      </div>
    </div>

    <div class="repuestos-actions" style="justify-content: space-between; width: 100%;">
      <button id="btn-repuestos-filtrar" class="btn-secundario" type="button" onclick="repuestosPlanillaFiltrar()"><i class="fas fa-filter"></i> Ok</button>
      <div class="panel-counter" style="margin-left:auto;" title="Cantidad de equipos filtrados">
        <i class="fas fa-list-check"></i>
        <span style="opacity:.8">Equipos:</span>
        <span id="repuestos-count">0</span>
      </div>
    </div>

    <div class="erp-table-card repuestos-table">
      <table class="tabla-erp">
        <thead>
          <tr>
            <th>Fecha</th>
            <th>ID Reparacion</th>
            <th>Equipo</th>
            <th>Tecnico</th>
            <th>Nro Pedido</th>
          </tr>
        </thead>
        <tbody id="tbody-repuestos-reparaciones"></tbody>
      </table>
    </div>

    <div class="repuestos-actions">
      <button id="btn-repuestos-listado" class="btn-secundario" type="button" onclick="repuestosPlanillaListado()"><i class="fas fa-list"></i> Listado</button>
      <button id="btn-repuestos-imprimir" class="btn-secundario" type="button" onclick="repuestosPlanillaImprimir()"><i class="fas fa-print"></i> Imprimir</button>
    </div>

    <div class="erp-table-card repuestos-table">
      <table class="tabla-erp">
        <thead>
          <tr>
            <th>Codigo</th>
            <th>Descripcion</th>
            <th>Cantidad</th>
          </tr>
        </thead>
        <tbody id="tbody-repuestos-listado"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- MODAL REPARACION DIARIA -->
<div id="modal-reparacion" class="modal-refactor" tabindex="-1">
  <div class="modal-contenido-refactor modal-erp-producto modal-agregar-producto-grande">
    <span class="cerrar" onclick="cerrarModalReparacion()">&times;</span>
    <h2 class="modal-titulo-principal" id="modal-titulo-reparacion"><i class="fas fa-tools"></i> Nueva Reparacion</h2>

    <form id="form-reparacion" autocomplete="off">
      <div class="form-grid">
        <div>
          <label>Cliente *</label>
          <select id="cliente_tipo" name="cliente_tipo" required>
            <option value="">Seleccione cliente</option>
            <option value="dota">Dota</option>
            <option value="externo">Externo</option>
          </select>
        </div>
      </div>

      <div id="cliente_externo_wrapper" class="form-grid" style="display:none;">
        <div>
          <label>Cliente externo *</label>
          <select id="cliente_id" name="cliente_id">
            <option value="">Seleccione</option>
          </select>
        </div>
      </div>

      <div class="form-grid doble">
        <div>
          <label>ID Reparacion (nuestro) *</label>
          <input type="text" name="id_reparacion" maxlength="20" required />
        </div>
        <div>
          <label>Nro Coche</label>
          <input type="text" name="coche_numero" maxlength="20" />
        </div>
      </div>
      <div class="form-grid">
        <div>
          <label>Nro Pedido (R.Vigente)</label>
          <input type="text" name="nro_pedido_ref" id="nro_pedido_ref" placeholder="Nro de pedido de licitaciones" />
        </div>
      </div>

      <div class="form-grid">
        <div>
          <label>Equipo/Familia *</label>
          <select id="familia_id" name="familia_id">
            <option value="">Seleccione un equipo</option>
          </select>
        </div>
      </div>

      <div class="form-grid">
        <div>
          <label>Tecnico asignado *</label>
          <select id="tecnico_id" name="tecnico_id" required>
            <option value="">Seleccione tecnico</option>
          </select>
        </div>
      </div>

      <div class="form-grid doble">
        <div>
          <label>Hora inicio *</label>
          <input type="time" name="hora_inicio" />
        </div>
        <div>
          <label>Hora fin</label>
          <input type="time" name="hora_fin" />
        </div>
      </div>

      <div class="form-grid">
        <div>
          <label>Trabajo realizado / Repuestos *</label>
          <textarea name="trabajo" id="trabajo" rows="3" required></textarea>
          <!-- Sugerencias para texto predictivo del campo trabajo -->
          <div id="trabajo-suggest" class="suggest-box" style="display:none;"></div>
          <div class="repuestos-actions">
            <input type="text" id="scan-codigo-repuesto" placeholder="Escanear o escribir código de producto y Enter" />
            <div class="repuestos-buttons">
              <button type="button" id="btn-seleccionar-repuesto" class="btn-secundario"><i class="fas fa-cubes"></i> Seleccionar</button>
              <button type="button" id="btn-scan-repuesto" class="btn-secundario"><i class="fas fa-barcode"></i> Escanear Código</button>
            </div>
          </div>
        </div>
      </div>

      <div class="form-grid">
        <div>
          <label>Es garantia?</label>
          <select name="garantia" id="garantia">
            <option value="no">No</option>
            <option value="si">Si</option>
          </select>
        </div>
      </div>

      <div id="garantia-extra-fields" style="display:none; margin-top:10px;">
        <div class="form-grid">
          <div>
            <label for="id_dota">ID DOTA</label>
            <input type="number" name="id_dota" id="id_dota" placeholder="Nro DOTA" />
          </div>
          <div>
            <label for="ultimo_reparador">Ultimo Reparador</label>
            <select name="ultimo_reparador" id="ultimo_reparador">
              <option value="">Seleccione</option>
            </select>
          </div>
          <div>
            <label for="resolucion">Resolucion</label>
            <select name="resolucion" id="resolucion">
              <option value="">Seleccione</option>
              <option value="aceptada">Aceptada</option>
              <option value="rechazada">Rechazada (Facturada)</option>
              <option value="funciona_ok">Funciona OK (Devolucion)</option>
            </select>
          </div>
        </div>
        <div class="form-grid doble">
          <div>
            <label for="garantia_prueba_banco">Prueba en banco</label>
            <textarea name="garantia_prueba_banco" id="garantia_prueba_banco" rows="2" placeholder="Resultados de banco de pruebas"></textarea>
          </div>
          <div>
            <label for="garantia_desarme">Desarme / falla</label>
            <textarea name="garantia_desarme" id="garantia_desarme" rows="2" placeholder="Observaciones del desarme"></textarea>
          </div>
        </div>
        <div class="form-grid">
          <div>
            <label for="garantia_template">Plantilla rápida</label>
            <select id="garantia_template">
              <option value="">Sin plantilla</option>
              <option value="funciona_ok">Funciona OK</option>
            </select>
          </div>
        </div>
      </div>

      <div class="form-grid">
        <div>
          <label>Observaciones</label>
          <textarea name="observaciones" rows="2"></textarea>
        </div>
      </div>

      <button type="submit" class="btn-guardar"><i class="fas fa-save"></i> Guardar Reparacion</button>
    </form>
  </div>
</div>

<!-- MODAL SCANNER CODIGO/QR -->
<div id="modal-scanner" class="modal-refactor" style="display:none;">
  <div class="modal-contenido-refactor modal-erp-producto" style="max-width:680px;">
    <span class="cerrar" onclick="cerrarModalScanner()">&times;</span>
    <h2 class="modal-titulo-principal"><i class="fas fa-barcode"></i> Escanear Código o QR</h2>
    <div style="display:flex; flex-direction:column; gap:10px;">
      <video id="scanner-video" playsinline style="width:100%; border-radius:8px; background:#000"></video>
      <div style="display:flex; gap:8px; align-items:center;">
        <input id="manual-scan-code" class="input-buscar" placeholder="Ingresar código manualmente" style="flex:1" />
        <button id="btn-add-by-code" class="btn-primary"><i class="fas fa-plus"></i> Agregar</button>
      </div>
      <small style="color:#64748b;">Tip: Permití el uso de la cámara. Si tu navegador no soporta detector, ingresá el código manualmente.</small>
    </div>
  </div>
</div>

<!-- MODAL GRUPOS -->
<div id="modal-grupos" class="modal-refactor">
  <div class="modal-contenido modal-erp-producto tabla-chica">
    <span class="cerrar" onclick="cerrarModalGrupos()">&times;</span>
    <h2 class="modal-titulo-principal"><i class="fas fa-layer-group"></i> Seleccionar Grupo</h2>
    <div class="erp-table-card">
      <table class="tabla-erp">
        <thead>
          <tr>
            <th>Seleccionar</th>
            <th>Grupo</th>
          </tr>
        </thead>
        <tbody id="tbody-grupos"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- MODAL PRODUCTOS -->
<div id="modal-productos" class="modal-refactor">
  <div class="modal-contenido modal-erp-producto tabla-chica">
    <span class="cerrar" onclick="cerrarModalProductos()">&times;</span>
    <h2 class="modal-titulo-principal"><i class="fas fa-box"></i> Seleccionar Producto</h2>
    <div class="buscador-historial" style="margin-top:0;">
      <input type="text" id="buscar-producto-planilla" class="input-buscar" placeholder="Buscar por código o descripción..." />
      <button id="btn-buscar-producto-planilla" class="btn-primary"><i class="fas fa-search"></i> Buscar</button>
    </div>
    <div class="erp-table-card">
      <table class="tabla-erp">
        <thead>
          <tr>
            <th>Accion</th>
            <th>Descripcion</th>
            <th>Codigo</th>
            <th>Stock</th>
          </tr>
        </thead>
        <tbody id="tbody-productos"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- MODAL DETALLE -->
<div id="modal-detalle" class="modal-refactor">
  <div class="modal-contenido-refactor modal-detalle-fixed">
    <span class="cerrar" onclick="cerrarModalDetalle()">&times;</span>
    <h2 class="modal-titulo-principal">
      <i class="fas fa-info-circle"></i> Detalle de Reparacion
    </h2>

    <div class="modal-detalle-scroll">
      <div class="modal-detalle-layout">
        <section class="detalle-card">
        <h3><i class="fas fa-clipboard-list"></i> Datos generales</h3>
        <div class="detalle-grid">
          <div><label>Cliente</label><span id="detalle-cliente">-</span></div>
          <div><label>ID Reparacion</label><span id="detalle-id-reparacion">-</span></div>
          <div><label>Nro Coche</label><span id="detalle-coche">-</span></div>
          <div><label>Equipo</label><span id="detalle-equipo">-</span></div>
          <div><label>Tecnico</label><span id="detalle-tecnico">-</span></div>
          <div><label>Hora inicio</label><span id="detalle-hora-inicio">-</span></div>
          <div><label>Hora fin</label><span id="detalle-hora-fin">-</span></div>
          <div><label>Nro Pedido</label><span id="detalle-nro-pedido">-</span></div>
        </div>
        </section>

        <section class="detalle-card detalle-garantia">
          <h3><i class="fas fa-shield-alt"></i> Garantia y estado</h3>
          <div class="detalle-grid garantia">
            <div><label>Garantia</label><span id="detalle-garantia">-</span></div>
            <div><label>ID DOTA</label><span id="detalle-id-dota">-</span></div>
            <div><label>Ultimo reparador</label><span id="detalle-ultimo-reparador">-</span></div>
            <div><label>Estado / Resolucion</label><span id="detalle-estado">-</span></div>
          </div>
        </section>
      </div>

      <section class="detalle-card detalle-textos">
        <h3><i class="fas fa-tools"></i> Trabajo y repuestos</h3>
        <div id="detalle-trabajo" class="detalle-texto"></div>
      </section>

      <section class="detalle-card detalle-textos">
        <h3><i class="fas fa-comment-alt"></i> Observaciones</h3>
        <div id="detalle-observaciones" class="detalle-texto"></div>
      </section>
    </div>
  </div>
</div>

<!-- MODAL HISTORIAL -->
<div id="modal-historial" class="modal-refactor" data-mode="historial">
  <div class="modal-contenido modal-historial-ancho">
    <span class="cerrar" onclick="cerrarModalHistorial()">&times;</span>
    <h2 class="modal-titulo-principal"><i class="fas fa-history"></i> Historial de Reparaciones</h2>

    <div class="historial-header">
      <div><b>ID Reparacion:</b> <span id="historial-id"></span></div>
      <div><b>Cliente:</b> <span id="historial-cliente"></span></div>
      <div><b>Equipo:</b> <span id="historial-equipo"></span></div>
      <div><b>Nro Coche:</b> <span id="historial-coche"></span></div>
    </div>

    <div id="historial-garantia-extra" class="historial-header garantia-extra" style="display:none;">
      <div><b>ID DOTA:</b> <span id="historial-id-dota">-</span></div>
      <div><b>Ultimo reparador:</b> <span id="historial-ultimo-reparador">-</span></div>
      <div><b>Resolucion:</b> <span id="historial-resolucion">-</span></div>
    </div>

    <div class="erp-table-card historial-tabla">
      <table class="tabla-erp">
        <thead>
          <tr id="historial-head-row">
            <th>Fecha</th>
            <th>Trabajo</th>
            <th>Hora Inicio</th>
            <th>Hora Fin</th>
            <th>Tecnico</th>
            <th>Garantia</th>
          </tr>
        </thead>
        <tbody id="tbody-historial"></tbody>
      </table>
    </div>
  </div>
</div>

