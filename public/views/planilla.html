<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Planilla Diaria</title>
  <link rel="stylesheet" href="/css/layout.css">
  <link rel="stylesheet" href="/css/tablas.css">
  <link rel="stylesheet" href="/css/botones.css">
  <link rel="stylesheet" href="/css/modales.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    .calendar-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 16px;
      padding: 20px;
    }

    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      width: 100%;
      max-width: 700px;
    }

    .calendar-header h2 {
      margin: 0;
      font-size: 1.5rem;
      color: #2176bd;
    }

    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 8px;
      width: 100%;
      max-width: 700px;
    }

    .calendar-day {
      background: #f9fbfd;
      border: 1px solid #dce6f5;
      border-radius: 8px;
      height: 90px;
      padding: 6px;
      cursor: pointer;
      transition: background 0.2s;
      display: flex;
      align-items: flex-start;
      justify-content: flex-start;
      font-size: 0.9rem;
    }

    .calendar-day:hover {
      background: #eaf5ff;
    }

    .calendar-day.empty {
      background: transparent;
      border: none;
      cursor: default;
    }

    .calendar-weekday {
      font-weight: bold;
      text-align: center;
      padding: 6px 0;
      color: #333;
    }
  </style>
</head>

<body class="main-dashboard">
  <!-- HEADER -->
  <header class="main-header">
    <div class="logo">
      <img src="/images/logo.png" alt="Logo Empresa" height="40" class="logo-header">
    </div>
    <div class="user-info">
      <i class="fas fa-user-circle"></i>
      <span id="user-name">Bienvenido, Usuario</span>
      <button class="logout-button" onclick="logout()">Salir</button>
    </div>
  </header>

  <!-- SIDEBAR -->
  <aside class="sidebar">
    <nav>
      <ul>
        <li><button class="sidebar-btn" onclick="irA('dota-inicio')"><i class="fas fa-home"></i> Inicio</button></li>
        <li><a href="/productos" class="sidebar-link"><i class="fas fa-box"></i> Productos</a></li>
        <li><a href="/reportes" class="sidebar-link"><i class="fas fa-chart-line"></i> Reportes</a></li>
        <li><a href="/usuarios" class="sidebar-link"><i class="fas fa-users"></i> Usuarios</a></li>
        <li><a href="/configuracion" class="sidebar-link"><i class="fas fa-cog"></i> Configuración</a></li>
        <hr>
        <li><a href="/planilla" class="sidebar-link active"><i class="fas fa-calendar-alt"></i> Planilla Diaria</a></li>
      </ul>
    </nav>
  </aside>

  <!-- CONTENIDO -->
  <main class="content">
    <div class="erp-main-card">
      <div class="erp-header-row">
        <div class="titulo-dota"><i class="fas fa-calendar-alt"></i> Planilla Diaria</div>
      </div>

      <div class="calendar-container">
        <div class="calendar-header">
          <button id="prevMonth" class="icon-button-erp visualizar"><i class="fas fa-chevron-left"></i></button>
          <h2 id="calendarTitle"></h2>
          <button id="nextMonth" class="icon-button-erp visualizar"><i class="fas fa-chevron-right"></i></button>
        </div>
        <div class="calendar-grid" id="calendarGrid"><!-- JS carga días --></div>
      </div>
    </div>
  </main>

  <!-- MODAL PLANILLA DIARIA -->
  <div id="modal-planilla" class="modal">
    <div class="modal-contenido modal-erp-producto modal-agregar-producto-grande">
      <span class="cerrar" onclick="cerrarModalPlanilla()">&times;</span>
      <h2 class="modal-titulo-principal"><i class="fas fa-clipboard-list"></i> Reparaciones del <span
          id="fecha-planilla"></span></h2>

      <!-- Tabla reparaciones -->
      <div class="erp-table-card">
        <table class="tabla-erp">
          <thead>
            <tr>
              <th>ID Equipo</th>
              <th>Cliente</th>
              <th>Técnico</th>
              <th>Trabajo</th>
              <th>Observaciones</th>
            </tr>
          </thead>
          <tbody id="tbody-reparaciones">
            <!-- JS carga -->
          </tbody>
        </table>
      </div>

      <!-- PANEL FLOTANTE -->
      <div class="erp-panel-flotante">
        <button id="btn-agregar-rep" class="icon-button-erp agregar" title="Agregar"><i
            class="fas fa-plus"></i></button>
        <button id="btn-modificar-rep" class="icon-button-erp modificar" title="Editar"><i
            class="fas fa-edit"></i></button>
        <button id="btn-eliminar-rep" class="icon-button-erp eliminar" title="Eliminar"><i
            class="fas fa-trash"></i></button>
      </div>
    </div>
  </div>

  <!-- MODAL REPARACIÓN DIARIA -->
  <div id="modal-reparacion" class="modal" tabindex="-1">
    <div class="modal-contenido modal-erp-producto modal-agregar-producto-grande">
      <span class="cerrar" onclick="cerrarModalReparacion()">&times;</span>
      <h2 class="modal-titulo-principal" id="modal-titulo-reparacion">
        <i class="fas fa-tools"></i> Nueva Reparación
      </h2>

      <form id="form-reparacion" autocomplete="off">
        <!-- Cliente -->
        <div class="form-grid">
          <div>
            <label>Cliente *</label>
            <select name="cliente_tipo" required>
              <option value="">Seleccione cliente</option>
              <option value="dota">Dota</option>
              <option value="externo">Externo</option>
            </select>
          </div>
        </div>

        <!-- ID Reparación + Nº Coche -->
        <div class="form-grid doble">
          <div>
            <label>ID Reparación (nuestro) *</label>
            <input type="text" name="id_reparacion" maxlength="20" required />
          </div>
          <div>
            <label>Nº Coche</label>
            <input type="text" name="coche_numero" maxlength="20" />
          </div>
        </div>

        <!-- Equipo -->
        <div class="form-grid">
          <div>
            <label>Equipo *</label>
            <select id="equipo_id" name="equipo_id" required>
              <option value="">Seleccione un equipo</option>
              <!-- JS cargará aquí -->
            </select>
          </div>
        </div>

        <!-- Técnico -->
        <div class="form-grid">
          <div>
            <label>Técnico asignado *</label>
            <select id="tecnico_id" name="tecnico_id" required>
              <option value="">Seleccione técnico</option>
              <!-- JS cargará aquí -->
            </select>
          </div>
        </div>

        <!-- Horarios -->
        <div class="form-grid doble">
          <div>
            <label>Hora inicio *</label>
            <input type="time" name="hora_inicio" required />
          </div>
          <div>
            <label>Hora fin</label>
            <input type="time" name="hora_fin" />
          </div>
        </div>

        <!-- Trabajo / Repuestos -->
        <div class="form-grid">
          <div>
            <label>Trabajo realizado / Repuestos *</label>
            <textarea name="trabajo" rows="3" required></textarea>
          </div>
        </div>

        <!-- Garantía -->
        <div class="form-grid">
          <div>
            <label>¿Es garantía?</label>
            <select name="garantia">
              <option value="no">No</option>
              <option value="si">Sí</option>
            </select>
          </div>
        </div>

        <!-- Observaciones -->
        <div class="form-grid">
          <div>
            <label>Observaciones</label>
            <textarea name="observaciones" rows="2"></textarea>
          </div>
        </div>

        <button type="submit" class="btn-guardar">
          <i class="fas fa-save"></i> Guardar Reparación
        </button>
      </form>
    </div>
  </div>


  <script>
    function logout() { if (confirm('¿Seguro que deseas salir?')) window.location.href = '/'; }
    function irA(seccion) { window.location.href = '/' + seccion; }

    const calendarTitle = document.getElementById("calendarTitle");
    const calendarGrid = document.getElementById("calendarGrid");
    let currentDate = new Date();

    function renderCalendar(date) {
      calendarGrid.innerHTML = "";
      const year = date.getFullYear();
      const month = date.getMonth();
      const monthName = date.toLocaleString("es-ES", { month: "long", year: "numeric" });
      calendarTitle.textContent = monthName.charAt(0).toUpperCase() + monthName.slice(1);
      const weekdays = ["Lun", "Mar", "Mié", "Jue", "Vie", "Sáb", "Dom"];
      weekdays.forEach(day => {
        const div = document.createElement("div");
        div.textContent = day;
        div.classList.add("calendar-weekday");
        calendarGrid.appendChild(div);
      });
      const firstDay = new Date(year, month, 1);
      const startDay = (firstDay.getDay() + 6) % 7;
      const totalDays = new Date(year, month + 1, 0).getDate();
      for (let i = 0; i < startDay; i++) {
        const emptyDiv = document.createElement("div");
        emptyDiv.classList.add("calendar-day", "empty");
        calendarGrid.appendChild(emptyDiv);
      }
      for (let day = 1; day <= totalDays; day++) {
        const div = document.createElement("div");
        div.classList.add("calendar-day");
        div.textContent = day;
        const fecha = new Date(year, month, day).toISOString().split("T")[0];
        div.onclick = () => abrirModalPlanilla(fecha);
        calendarGrid.appendChild(div);
      }
    }

    document.getElementById("prevMonth").onclick = () => { currentDate.setMonth(currentDate.getMonth() - 1); renderCalendar(currentDate); }
    document.getElementById("nextMonth").onclick = () => { currentDate.setMonth(currentDate.getMonth() + 1); renderCalendar(currentDate); }

    renderCalendar(currentDate);

    // === MODAL PLANILLA ===
    function abrirModalPlanilla(fecha) {
      document.getElementById("fecha-planilla").textContent = fecha;
      document.getElementById("modal-planilla").classList.add("mostrar");
      cargarReparaciones(fecha);
    }
    function cerrarModalPlanilla() {
      document.getElementById("modal-planilla").classList.remove("mostrar");
      document.getElementById("tbody-reparaciones").innerHTML = "";
    }

    async function cargarReparaciones(fecha) {
      try {
        const res = await fetch(`/api/reparaciones?fecha=${fecha}`);
        const data = await res.json();
        const tbody = document.getElementById("tbody-reparaciones");
        tbody.innerHTML = "";
        if (!data.length) {
          tbody.innerHTML = "<tr><td colspan='5'>No hay reparaciones</td></tr>";
        } else {
          data.forEach(r => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>${r.id_equipo}</td>
              <td>${r.cliente}</td>
              <td>${r.tecnico}</td>
              <td>${r.trabajo}</td>
              <td>${r.observaciones || "-"}</td>`;
            tbody.appendChild(tr);
          });
        }
      } catch (err) {
        console.error(err);
      }
    }

    // === MODAL REPARACIÓN ===
    function abrirModalReparacion(titulo = "Nueva Reparación", datos = null) {
      document.getElementById("modal-titulo-reparacion").textContent = titulo;
      document.getElementById("modal-reparacion").classList.add("mostrar");
      document.getElementById("form-reparacion").reset();

      if (datos) {
        // precargar datos para edición
        for (const [key, value] of Object.entries(datos)) {
          if (document.querySelector(`[name="${key}"]`)) {
            document.querySelector(`[name="${key}"]`).value = value;
          }
        }
      }
    }

    function cerrarModalReparacion() {
      document.getElementById("modal-reparacion").classList.remove("mostrar");
    }

    // Botones del panel flotante de planilla
    document.getElementById("btn-agregar-rep").onclick = () => abrirModalReparacion();
    document.getElementById("btn-modificar-rep").onclick = () => {
      alert("Editar reparación (pendiente implementar)");
    };
    document.getElementById("btn-eliminar-rep").onclick = () => {
      alert("Eliminar reparación (pendiente implementar)");
    };

  </script>
</body>

</html>